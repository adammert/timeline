<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timeline Visualizer v1.2</title>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
    integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">

  <!-- Application Scripts - Order matters! -->
  <script src="js/config.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/parser.js"></script>
  <script src="js/renderer.js"></script>
  <script src="js/search.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/export.js"></script>
  <script src="js/images.js"></script>
  <script src="js/presentation.js"></script>
  <script src="js/app.js"></script>
</head>

<body>
  <div class="app-container">
    <!-- Input Panel -->
    <div class="input-panel">
      <div class="header-controls">
        <div class="header-buttons">
          <button class="templates-toggle" id="templatesToggle" title="Templates">üìÑ</button>
          <button class="stats-toggle" id="statsToggle" title="Statistiken">üìä</button>
          <button class="view-toggle" id="viewToggle" title="Ansicht wechseln">üõ§Ô∏è</button>
          <button class="theme-toggle" id="themeToggle" title="Theme wechseln">üåô</button>
          <button class="help-toggle" id="helpToggle" title="Hilfe & Info">‚ùì</button>
          <button class="help-toggle" id="debugToggle" title="Debug Test">ü™≤</button>
        </div>
        <h1>Timeline Editor</h1>
        <div style="width: 130px"></div>
      </div>

      <label for="markdownInput">Ereignisse eingeben:</label>
      <div class="textarea-container">
        <textarea id="markdownInput" placeholder="Beispiel:
date: 2023-01-15 10:00:00
## Projektstart
- Kick-off Meeting

---
date: 2023-01-20 14:30:00
Erster Meilenstein erreicht
> Super Fortschritt!"></textarea>
        <div class="autosave-indicator" id="autosaveIndicator">Gespeichert</div>
      </div>

      <div class="search-filter-container">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Suche in Timeline... (Strg+F)" />
          <button class="search-clear" id="searchClear">√ó</button>
        </div>
        <div class="filter-dropdown">
          <button class="filter-button" id="filterButton">
            <span>Filter</span>
            <span id="filterCount"></span>
          </button>
          <div class="filter-menu" id="filterMenu">
            <div class="filter-option">
              <input type="checkbox" id="filter-critical" value="critical" checked />
              <label for="filter-critical">Critical</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-warning" value="warning" checked />
              <label for="filter-warning">Warning</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-success" value="success" checked />
              <label for="filter-success">Success</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-meeting" value="meeting" checked />
              <label for="filter-meeting">Meeting</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-work" value="work" checked />
              <label for="filter-work">Work</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-none" value="none" checked />
              <label for="filter-none">Ohne Kategorie</label>
            </div>
          </div>
        </div>
      </div>

      <button id="visualizeBtn">Pr√§sentation √∂ffnen</button>
      <div class="keyboard-hint">
        Strg+Enter: Pr√§sentation | Strg+S: Speichern | Strg+F: Suche | Strg+V: Screenshot einf√ºgen
      </div>

      <div class="save-options">
        <button id="loadMarkdownBtn">Markdown laden</button>
        <button id="saveMarkdownBtn">Markdown speichern</button>
        <button id="saveHtmlBtn">HTML speichern</button>
        <button id="savePngBtn">PNG speichern</button>
        <button id="savePdfBtn">PDF speichern</button>
      </div>
      <input id="loadMarkdownInput" type="file" accept=".md,text/markdown" style="display: none" />
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <div id="timelineOutput" class="timeline">
        <p class="info-message">
          Die Visualisierung deiner Ereignisse erscheint hier. Gib links Daten ein und klicke auf 'Visualisieren'.
        </p>
      </div>
    </div>
  </div>

  <!-- Statistics Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Timeline Statistiken</h2>
        <button class="modal-close" id="statsModalClose">√ó</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalEvents">0</div>
          <div class="stat-label">Gesamt Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="upcomingEvents">0</div>
          <div class="stat-label">Zuk√ºnftige Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pastEvents">0</div>
          <div class="stat-label">Vergangene Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="durationEvents">0</div>
          <div class="stat-label">Dauer-Ereignisse</div>
        </div>
      </div>
      <div class="class-distribution">
        <h3>Verteilung nach Kategorie</h3>
        <div id="classDistribution"></div>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div id="templatesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Timeline Templates</h2>
        <button class="modal-close" id="templatesModalClose">√ó</button>
      </div>
      <div class="template-grid" id="templateGrid"></div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>‚ùì Hilfe & Informationen</h2>
        <button class="modal-close" id="helpModalClose">√ó</button>
      </div>
      <div class="help-content">
        <div class="help-section">
          <h3>üìù Markdown-Syntax</h3>
          <p>Ereignisse werden durch <code>---</code> getrennt und folgen diesem Format:</p>
          <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">date: 2025-01-15 14:30:00
end_date: 2025-01-20 (optional)
class: warning (optional)
## Titel (optional)
Inhalt in Markdown-Format
- Listen
- **Fett**
- *Kursiv*

---
N√§chstes Ereignis...</pre>
        </div>

        <div class="help-section">
          <h3>üìÖ Datumsformate</h3>
          <ul>
            <li><strong>ISO:</strong> <code>2025-01-15</code> oder <code>2025-01-15 14:30:00</code></li>
            <li><strong>Deutsch:</strong> <code>15.01.2025</code> oder <code>15.01.2025 14:30</code></li>
            <li><strong>Quartale:</strong> <code>Q1 2025</code> oder <code>2025 Q1</code></li>
            <li><strong>Monate:</strong> <code>Januar 2025</code> oder <code>2025 Januar</code></li>
          </ul>
        </div>

        <div class="help-section">
          <h3>üé® Event-Kategorien</h3>
          <ul>
            <li><code>class: critical</code> - Kritische Ereignisse (rot)</li>
            <li><code>class: warning</code> - Warnungen (orange)</li>
            <li><code>class: success</code> - Erfolge (gr√ºn)</li>
            <li><code>class: meeting</code> - Meetings (lila)</li>
            <li><code>class: work</code> - Arbeit (blau)</li>
          </ul>
        </div>

        <div class="help-section">
          <h3>üñºÔ∏è Bilder einf√ºgen (NEU in v1.1)</h3>
          <ul>
            <li><strong>Drag & Drop:</strong> Ziehe Bilder direkt ins Textfeld</li>
            <li><strong>Screenshot:</strong> Dr√ºcke <kbd>Strg+V</kbd> im Textfeld</li>
            <li><strong>Syntax:</strong> <code>![Beschreibung](images/bild.png)</code></li>
            <li><strong>Speicherung:</strong> Bilder werden in IndexedDB gespeichert</li>
            <li><strong>Export:</strong> HTML enth√§lt eingebettete Base64-Bilder</li>
          </ul>
        </div>

        <div class="help-section">
          <h3>‚å®Ô∏è Tastenkombinationen</h3>
          <ul>
            <li><kbd>Strg+Enter</kbd> - Pr√§sentation √∂ffnen/schlie√üen</li>
            <li><kbd>Strg+S</kbd> - Markdown speichern</li>
            <li><kbd>Strg+F</kbd> - Suche fokussieren</li>
            <li><kbd>Strg+V</kbd> - Screenshot einf√ºgen</li>
            <li><kbd>Strg+Z</kbd> - R√ºckg√§ngig</li>
            <li><kbd>Strg+Y</kbd> - Wiederherstellen</li>
            <li><kbd>ESC</kbd> - Pr√§sentation/Modals schlie√üen</li>
          </ul>
        </div>

        <div class="help-section">
          <h3>üíæ Export-Optionen</h3>
          <ul>
            <li><strong>Markdown:</strong> Mit oder ohne Bilder-Ordner (File System Access API)</li>
            <li><strong>HTML:</strong> Standalone-Datei mit eingebetteten Bildern (Base64)</li>
            <li><strong>PNG:</strong> Timeline als Bild exportieren</li>
            <li><strong>PDF:</strong> Timeline als PDF-Dokument</li>
          </ul>
        </div>

        <div class="help-section">
          <h3>üé¨ Pr√§sentationsmodus</h3>
          <p>√ñffnet ein separates Fenster (1920√ó1080) f√ºr Pr√§sentationen. √Ñnderungen werden live synchronisiert. Filter
            und Suche werden ebenfalls √ºbertragen.</p>
        </div>

        <div class="help-section">
          <h3>üí° Tipps</h3>
          <ul>
            <li>Verwende <code>end_date</code> f√ºr Dauer-Events mit visuellen Verbindungslinien</li>
            <li>Klicke auf das Datum eines Events um zur Markdown-Quelle zu springen</li>
            <li>Nutze Filter um Events nach Kategorie ein-/auszublenden</li>
            <li>Alle Daten werden lokal im Browser gespeichert (LocalStorage + IndexedDB)</li>
            <li>Templates bieten Startpunkte f√ºr verschiedene Anwendungsf√§lle</li>
          </ul>
        </div>

                  <div class="help-section changelog">
                  <h3>üìã Changelog</h3>
        
                  <div class="version-block">
                    <h4>Version 1.2 - Filter Export & Bugfixes (November 2025)</h4>
                    <ul>
                      <li>‚ú® <strong>Export-Filter:</strong> Alle Exporte (HTML, MD, PNG, PDF) ber√ºcksichtigen nun die aktiven Filter.</li>
                      <li>üêõ <strong>Bugfix:</strong> Ein Timing-Fehler wurde behoben, der verhinderte, dass Filter korrekt auf Exporte angewendet wurden.</li>
                    </ul>
                  </div>
        
                  <div class="version-block">
                    <h4>Version 1.1 - Bild-Support (Januar 2025)</h4>
                    <ul>
                      <li>‚ú® <strong>Bilder per Drag & Drop einf√ºgen:</strong> Ziehe Bilder direkt ins Textfeld</li>
                      <li>‚ú® <strong>Screenshot-Paste:</strong> Strg+V f√ºgt Screenshots direkt ein</li>
                      <li>üíæ <strong>IndexedDB-Speicherung:</strong> Bilder werden lokal gespeichert</li>
                      <li>üì§ <strong>HTML-Export mit Bildern:</strong> Base64-eingebettet f√ºr Standalone-Dateien</li>
                      <li>üì§ <strong>Markdown-Export mit images/:</strong> Ordnerstruktur mit File System Access API</li>
                      <li>üé® <strong>Bilder in Pr√§sentation:</strong> Werden automatisch angezeigt</li>
                      <li>üåì <strong>Theme-Support:</strong> Hell/Dunkel-Modus auch im HTML-Export</li>
                      <li>üêõ <strong>Bugfixes:</strong> DOM-Rendering optimiert, Konsolenfehler behoben</li>
                    </ul>
                    <p style="font-size: 0.9em; color: var(--secondary-color); margin-top: 10px;">
                      <em>Bilder werden als <code>![alt](images/filename.png)</code> referenziert f√ºr Git-Kompatibilit√§t.</em>
                    </p>
                  </div>
        
                  <div class="version-block">
                    <h4>Version 1.0 - Initial Release</h4>
                    <ul>
                      <li>üìù Markdown-basierte Timeline-Erstellung</li>
                      <li>üé® Flexible Event-Kategorien mit Farbcodierung</li>
                      <li>üìÖ Multiple Datumsformate (ISO, Deutsch, Quartale, Monate)</li>
                      <li>‚è±Ô∏è Dauer-Events mit visuellen Verbindungen</li>
                      <li>üîç Live-Suche mit Highlighting</li>
                      <li>üéØ Filter nach Kategorien</li>
                      <li>üìä Statistik-Dashboard</li>
                      <li>üìã Vorgefertigte Templates</li>
                      <li>üíæ Auto-Save mit LocalStorage</li>
                      <li>‚èÆÔ∏è Undo/Redo-Funktion</li>
                      <li>üåì Hell/Dunkel-Theme</li>
                      <li>üé¨ Pr√§sentationsmodus (1920√ó1080)</li>
                      <li>üì§ Export: Markdown, HTML, PNG, PDF</li>
                    </ul>
                  </div>
                </div>
        <div class="help-section"
          style="background: #f0f8ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
          <h3>‚ÑπÔ∏è √úber Timeline Visualizer</h3>
          <p><strong>Version:</strong> 1.2</p>
          <p><strong>Technologie:</strong> Vanilla JavaScript, Marked.js, IndexedDB</p>
          <p><strong>Browser-Anforderungen:</strong> Chrome 90+, Firefox 88+, Safari 14+, Edge 90+</p>
          <p><strong>Datenschutz:</strong> Alle Daten werden nur lokal im Browser gespeichert. Keine
            Server-Kommunikation.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div id="debugModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîç Debug Informationen</h2>
        <button class="modal-close" id="debugModalClose">√ó</button>
      </div>
      <div id="debugOutput"
        style="font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px;">
        <p>Teste...</p>
      </div>
      <button id="testDropZone"
        style="margin-top: 15px; width: 100%; padding: 40px; border: 3px dashed #007bff; background: #363636; border-radius: 8px; cursor: pointer;">
        üìé Bild hierher ziehen zum Testen
      </button>
    </div>
  </div>

  <!-- Debug Script -->
  <script>
    // Debug functionality
    async function runDebugTests() {
      const output = document.getElementById('debugOutput');
      let html = '';

      function log(msg, isError = false) {
        const color = isError ? 'red' : 'green';
        html += `<div style="color: ${color}; margin: 5px 0;">${isError ? '‚ùå' : '‚úÖ'} ${msg}</div>`;
        output.innerHTML = html;
        console.log(msg);
      }

      try {
        log(`<strong>Browser:</strong> ${navigator.userAgent}`);
        log(`<strong>URL:</strong> ${window.location.href}`);
        log(`<strong>Origin:</strong> ${window.location.origin}`);
        log(`<strong>Protocol:</strong> ${window.location.protocol}`);

        if (!window.indexedDB) {
          log('IndexedDB wird nicht unterst√ºtzt!', true);
          return;
        }
        log('IndexedDB wird unterst√ºtzt');

        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          log('LocalStorage funktioniert');
        } catch (e) {
          log('LocalStorage blockiert: ' + e.message, true);
        }

        if (!window.TimelineApp || !window.TimelineApp.Images) {
          log('TimelineApp.Images nicht geladen!', true);
          return;
        }
        log('TimelineApp.Images ist geladen');

        try {
          await TimelineApp.Images.init();
          log('IndexedDB erfolgreich initialisiert');

          if (TimelineApp.Images.db) {
            log(`Database Name: ${TimelineApp.Images.db.name}`);
            log(`Database Version: ${TimelineApp.Images.db.version}`);
          }
        } catch (e) {
          log('IndexedDB Initialisierung fehlgeschlagen: ' + e.message, true);
          return;
        }

        try {
          const testBlob = new Blob(['test'], { type: 'image/png' });
          const testName = 'test_' + Date.now() + '.png';
          await TimelineApp.Images.storeImage(testName, testBlob);
          log('Test-Bild erfolgreich gespeichert');

          const retrieved = await TimelineApp.Images.getImage(testName);
          if (retrieved) {
            log('Test-Bild erfolgreich abgerufen');
            await TimelineApp.Images.deleteImage(testName);
            log('Test-Bild erfolgreich gel√∂scht');
          } else {
            log('Test-Bild konnte nicht abgerufen werden', true);
          }
        } catch (e) {
          log('Fehler beim Test-Bild: ' + e.message, true);
        }

        if ('FileReader' in window) {
          log('FileReader API verf√ºgbar');
        } else {
          log('FileReader API nicht verf√ºgbar', true);
        }

        if (navigator.clipboard) {
          log('Clipboard API verf√ºgbar');
        } else {
          log('Clipboard API eingeschr√§nkt (ben√∂tigt HTTPS)', true);
        }

        log('<strong>=== ALLE TESTS ABGESCHLOSSEN ===</strong>');

      } catch (e) {
        log('Unerwarteter Fehler: ' + e.message, true);
        console.error(e);
      }
    }

    // Setup help and debug modals
    document.addEventListener('DOMContentLoaded', () => {
      // Help Modal
      const helpToggle = document.getElementById('helpToggle');
      const helpModal = document.getElementById('helpModal');
      const helpModalClose = document.getElementById('helpModalClose');

      if (helpToggle) {
        helpToggle.addEventListener('click', () => {
          helpModal.classList.add('show');
        });
      }

      if (helpModalClose) {
        helpModalClose.addEventListener('click', () => {
          helpModal.classList.remove('show');
        });
      }

      if (helpModal) {
        helpModal.addEventListener('click', (e) => {
          if (e.target === helpModal) {
            helpModal.classList.remove('show');
          }
        });
      }

      // Debug Modal
      const debugToggle = document.getElementById('debugToggle');
      const debugModal = document.getElementById('debugModal');
      const debugModalClose = document.getElementById('debugModalClose');
      const testDropZone = document.getElementById('testDropZone');

      if (debugToggle) {
        debugToggle.addEventListener('click', () => {
          debugModal.classList.add('show');
          runDebugTests();
        });
      }

      if (debugModalClose) {
        debugModalClose.addEventListener('click', () => {
          debugModal.classList.remove('show');
        });
      }

      if (debugModal) {
        debugModal.addEventListener('click', (e) => {
          if (e.target === debugModal) {
            debugModal.classList.remove('show');
          }
        });
      }

      if (testDropZone) {
        testDropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          testDropZone.style.background = '#cce5ff';
        });

        testDropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          testDropZone.style.background = '#f0f8ff';
        });

        testDropZone.addEventListener('drop', async (e) => {
          e.preventDefault();
          testDropZone.style.background = '#f0f8ff';

          const output = document.getElementById('debugOutput');
          let html = output.innerHTML;

          html += '<hr><strong>DROP TEST:</strong><br>';

          if (e.dataTransfer && e.dataTransfer.files) {
            html += `Anzahl Dateien: ${e.dataTransfer.files.length}<br>`;

            for (let i = 0; i < e.dataTransfer.files.length; i++) {
              const file = e.dataTransfer.files[i];
              html += `Datei ${i + 1}: ${file.name} (${file.type}, ${file.size} bytes)<br>`;

              if (file.type.startsWith('image/')) {
                try {
                  const filename = await TimelineApp.Images.handleImageFile(file);
                  if (filename) {
                    html += `<span style="color: green;">‚úÖ Erfolgreich gespeichert als: ${filename}</span><br>`;
                  } else {
                    html += '<span style="color: red;">‚ùå Speichern fehlgeschlagen</span><br>';
                  }
                } catch (err) {
                  html += `<span style="color: red;">‚ùå Fehler: ${err.message}</span><br>`;
                }
              }
            }
          } else {
            html += '<span style="color: red;">Keine Dateien gefunden!</span><br>';
          }

          output.innerHTML = html;
          output.scrollTop = output.scrollHeight;
        });
      }
    });
  </script>

  <style>
    /* Help Modal Specific Styles */
    .help-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .help-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .help-section:last-child {
      border-bottom: none;
    }

    .help-section h3 {
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 10px;
    }

    .help-section ul {
      margin: 10px 0;
      padding-left: 25px;
    }

    .help-section li {
      margin: 8px 0;
      line-height: 1.6;
    }

    .help-section code {
      background-color: var(--hover-bg);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .help-section kbd {
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      white-space: nowrap;
    }

    [data-theme="dark"] .help-section kbd {
      background-color: #3a3a3a;
      border-color: #555;
      color: #e0e0e0;
    }

    .help-section pre {
      background: var(--hover-bg);
      padding: 12px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 0.9em;
      line-height: 1.4;
      color: var(--text-color);
    }

    [data-theme="dark"] .help-section pre {
      background: #2a2a2a;
      color: #e0e0e0;
    }

    .changelog .version-block {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--hover-bg);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .changelog .version-block h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .changelog .version-block ul {
      margin: 5px 0;
    }

    .help-toggle {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }

    .help-toggle:hover {
      background-color: var(--hover-bg);
    }

    .help-toggle.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
  </style>
</body>

</html>