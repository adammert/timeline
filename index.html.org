<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timeline Visualizer</title>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
    integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">

  <!-- Application Scripts - Order matters! -->
  <script src="js/config.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/parser.js"></script>
  <script src="js/renderer.js"></script>
  <script src="js/search.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/export.js"></script>
  <script src="js/images.js"></script>
  <script src="js/presentation.js"></script>
  <script src="js/app.js?v=2"></script>
</head>

<body>
  <div class="app-container">
    <!-- Input Panel -->
    <div class="input-panel">
      <div class="header-controls">
        <div class="header-buttons">
          <button class="templates-toggle" id="templatesToggle" title="Templates">üìÑ</button>
          <button class="stats-toggle" id="statsToggle" title="Statistiken">üìä</button>
          <button class="theme-toggle" id="themeToggle" title="Theme wechseln">üåô</button>
          <!-- DEBUG BUTTON -->
          <button class="debug-toggle" id="debugToggle" title="Debug Test"
            style="background-color: #ff6b6b;">üîç</button>
        </div>
        <h1>Timeline Editor</h1>
        <div style="width: 130px"></div>
      </div>

      <label for="markdownInput">Ereignisse eingeben:</label>
      <div class="textarea-container">
        <textarea id="markdownInput" placeholder="Beispiel:
date: 2023-01-15 10:00:00
## Projektstart
- Kick-off Meeting

---
date: 2023-01-20 14:30:00
Erster Meilenstein erreicht
> Super Fortschritt!"></textarea>
        <div class="autosave-indicator" id="autosaveIndicator">Gespeichert</div>
      </div>

      <div class="search-filter-container">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Suche in Timeline... (Strg+F)" />
          <button class="search-clear" id="searchClear">√ó</button>
        </div>
        <div class="filter-dropdown">
          <button class="filter-button" id="filterButton">
            <span>Filter</span>
            <span id="filterCount"></span>
          </button>
          <div class="filter-menu" id="filterMenu">
            <div class="filter-option">
              <input type="checkbox" id="filter-critical" value="critical" checked />
              <label for="filter-critical">Critical</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-warning" value="warning" checked />
              <label for="filter-warning">Warning</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-success" value="success" checked />
              <label for="filter-success">Success</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-meeting" value="meeting" checked />
              <label for="filter-meeting">Meeting</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-work" value="work" checked />
              <label for="filter-work">Work</label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-none" value="none" checked />
              <label for="filter-none">Ohne Kategorie</label>
            </div>
          </div>
        </div>
      </div>

      <button id="visualizeBtn">Pr√§sentation √∂ffnen</button>
      <div class="keyboard-hint">
        Strg+Enter: Pr√§sentation | Strg+S: Speichern | Strg+F: Suche | Strg+V: Screenshot einf√ºgen
      </div>

      <div class="save-options">
        <button id="loadMarkdownBtn">Markdown laden</button>
        <button id="saveMarkdownBtn">Markdown speichern</button>
        <button id="saveHtmlBtn">HTML speichern</button>
        <button id="savePngBtn">PNG speichern</button>
        <button id="savePdfBtn">PDF speichern</button>
      </div>
      <input id="loadMarkdownInput" type="file" accept=".md,text/markdown" style="display: none" />
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <div id="timelineOutput" class="timeline">
        <p class="info-message">
          Die Visualisierung deiner Ereignisse erscheint hier. Gib links Daten ein und klicke auf 'Visualisieren'.
        </p>
      </div>
    </div>
  </div>

  <!-- Statistics Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Timeline Statistiken</h2>
        <button class="modal-close" id="statsModalClose">√ó</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalEvents">0</div>
          <div class="stat-label">Gesamt Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="upcomingEvents">0</div>
          <div class="stat-label">Zuk√ºnftige Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pastEvents">0</div>
          <div class="stat-label">Vergangene Ereignisse</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="durationEvents">0</div>
          <div class="stat-label">Dauer-Ereignisse</div>
        </div>
      </div>
      <div class="class-distribution">
        <h3>Verteilung nach Kategorie</h3>
        <div id="classDistribution"></div>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div id="templatesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Timeline Templates</h2>
        <button class="modal-close" id="templatesModalClose">√ó</button>
      </div>
      <div class="template-grid" id="templateGrid"></div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div id="debugModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîç Debug Informationen</h2>
        <button class="modal-close" id="debugModalClose">√ó</button>
      </div>
      <div id="debugOutput"
        style="font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px;">
        <p>Teste...</p>
      </div>
      <button id="testDropZone"
        style="margin-top: 15px; width: 100%; padding: 40px; border: 3px dashed #007bff; background: #f0f8ff; border-radius: 8px; cursor: pointer;">
        üìé Bild hierher ziehen zum Testen
      </button>
    </div>
  </div>

  <!-- Debug Script -->
  <script>
    // Debug functionality
    async function runDebugTests() {
      const output = document.getElementById('debugOutput');
      let html = '';

      function log(msg, isError = false) {
        const color = isError ? 'red' : 'green';
        html += `<div style="color: ${color}; margin: 5px 0;">${isError ? '‚ùå' : '‚úÖ'} ${msg}</div>`;
        output.innerHTML = html;
        console.log(msg);
      }

      try {
        // Test 1: Basic Info
        log(`<strong>Browser:</strong> ${navigator.userAgent}`);
        log(`<strong>URL:</strong> ${window.location.href}`);
        log(`<strong>Origin:</strong> ${window.location.origin}`);
        log(`<strong>Protocol:</strong> ${window.location.protocol}`);

        // Test 2: IndexedDB Support
        if (!window.indexedDB) {
          log('IndexedDB wird nicht unterst√ºtzt!', true);
          return;
        }
        log('IndexedDB wird unterst√ºtzt');

        // Test 3: Cookies/LocalStorage
        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          log('LocalStorage funktioniert');
        } catch (e) {
          log('LocalStorage blockiert: ' + e.message, true);
        }

        // Test 4: TimelineApp.Images
        if (!window.TimelineApp || !window.TimelineApp.Images) {
          log('TimelineApp.Images nicht geladen!', true);
          return;
        }
        log('TimelineApp.Images ist geladen');

        // Test 5: Initialize IndexedDB
        try {
          await TimelineApp.Images.init();
          log('IndexedDB erfolgreich initialisiert');

          // Test 6: Database Info
          if (TimelineApp.Images.db) {
            log(`Database Name: ${TimelineApp.Images.db.name}`);
            log(`Database Version: ${TimelineApp.Images.db.version}`);
          }
        } catch (e) {
          log('IndexedDB Initialisierung fehlgeschlagen: ' + e.message, true);
          log('Error Details: ' + JSON.stringify(e), true);
          return;
        }

        // Test 7: Try to store a test image
        try {
          const testBlob = new Blob(['test'], { type: 'image/png' });
          const testName = 'test_' + Date.now() + '.png';
          await TimelineApp.Images.storeImage(testName, testBlob);
          log('Test-Bild erfolgreich gespeichert');

          // Test 8: Try to retrieve it
          const retrieved = await TimelineApp.Images.getImage(testName);
          if (retrieved) {
            log('Test-Bild erfolgreich abgerufen');
            // Clean up
            await TimelineApp.Images.deleteImage(testName);
            log('Test-Bild erfolgreich gel√∂scht');
          } else {
            log('Test-Bild konnte nicht abgerufen werden', true);
          }
        } catch (e) {
          log('Fehler beim Test-Bild: ' + e.message, true);
        }

        // Test 9: Drag & Drop API
        if ('FileReader' in window) {
          log('FileReader API verf√ºgbar');
        } else {
          log('FileReader API nicht verf√ºgbar', true);
        }

        // Test 10: Clipboard API
        if (navigator.clipboard) {
          log('Clipboard API verf√ºgbar');
        } else {
          log('Clipboard API eingeschr√§nkt (ben√∂tigt HTTPS)', true);
        }

        log('<strong>=== ALLE TESTS ABGESCHLOSSEN ===</strong>');

      } catch (e) {
        log('Unerwarteter Fehler: ' + e.message, true);
        console.error(e);
      }
    }

    // Setup debug button and modal
    document.addEventListener('DOMContentLoaded', () => {
      const debugToggle = document.getElementById('debugToggle');
      const debugModal = document.getElementById('debugModal');
      const debugModalClose = document.getElementById('debugModalClose');
      const testDropZone = document.getElementById('testDropZone');

      if (debugToggle) {
        debugToggle.addEventListener('click', () => {
          debugModal.classList.add('show');
          runDebugTests();
        });
      }

      if (debugModalClose) {
        debugModalClose.addEventListener('click', () => {
          debugModal.classList.remove('show');
        });
      }

      if (debugModal) {
        debugModal.addEventListener('click', (e) => {
          if (e.target === debugModal) {
            debugModal.classList.remove('show');
          }
        });
      }

      // Test drop zone
      if (testDropZone) {
        testDropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          testDropZone.style.background = '#cce5ff';
        });

        testDropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          testDropZone.style.background = '#f0f8ff';
        });

        testDropZone.addEventListener('drop', async (e) => {
          e.preventDefault();
          testDropZone.style.background = '#f0f8ff';

          const output = document.getElementById('debugOutput');
          let html = output.innerHTML;

          html += '<hr><strong>DROP TEST:</strong><br>';

          if (e.dataTransfer && e.dataTransfer.files) {
            html += `Anzahl Dateien: ${e.dataTransfer.files.length}<br>`;

            for (let i = 0; i < e.dataTransfer.files.length; i++) {
              const file = e.dataTransfer.files[i];
              html += `Datei ${i + 1}: ${file.name} (${file.type}, ${file.size} bytes)<br>`;

              if (file.type.startsWith('image/')) {
                try {
                  const filename = await TimelineApp.Images.handleImageFile(file);
                  if (filename) {
                    html += `<span style="color: green;">‚úÖ Erfolgreich gespeichert als: ${filename}</span><br>`;
                  } else {
                    html += '<span style="color: red;">‚ùå Speichern fehlgeschlagen</span><br>';
                  }
                } catch (err) {
                  html += `<span style="color: red;">‚ùå Fehler: ${err.message}</span><br>`;
                }
              }
            }
          } else {
            html += '<span style="color: red;">Keine Dateien gefunden!</span><br>';
          }

          output.innerHTML = html;
          output.scrollTop = output.scrollHeight;
        });
      }
    });
  </script>
</body>

</html>